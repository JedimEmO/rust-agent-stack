# File Service Backend

A production-ready file service backend built with Axum and the `file_service!` macro.

## Features

- 📁 **File Upload/Download** - Multipart file uploads with streaming downloads
- 🔐 **JWT Authentication** - Secure endpoints with role-based access
- 💾 **File Storage** - UUID-based file storage with metadata tracking
- 🌐 **CORS Support** - Full CORS configuration for web clients
- 📊 **Logging** - Structured logging with tracing

## Setup

1. Copy the environment file:
   ```bash
   cp .env.example .env
   ```

2. Edit `.env` and set your JWT secret

3. Run the server:
   ```bash
   cargo run
   ```

The server will start on `http://localhost:3000`.

## API Endpoints

Generated by the `file_service!` macro:

### Public Endpoints
- `POST /api/documents/upload` - Upload a file (no auth required)
- `GET /api/documents/download/{file_id}` - Download a file (no auth required)

### Secure Endpoints  
- `POST /api/documents/upload_profile_picture` - Upload with auth (requires "user" permission)
- `GET /api/documents/download_secure/{file_id}` - Download with auth (requires "user" permission)

## Authentication

This example uses a simple mock authentication provider that accepts only one valid token:

- **Valid Token**: `validtoken`
- **User ID**: `testuser`
- **Permissions**: `["user"]`

To authenticate, set the Authorization header:
```
Authorization: Bearer validtoken
```

Any other token will be rejected.

## File Storage

Files are stored in the `STORAGE_PATH` directory (default: `./uploads`) with the structure:
```
uploads/
  ├── {uuid}.jpg
  ├── {uuid}.pdf
  └── {uuid}.{ext}
```

Each file is assigned a UUID and retains its original extension.

## Configuration

Environment variables:
- `STORAGE_PATH` - Directory for file storage (default: `./uploads`)
- `RUST_LOG` - Logging configuration

## Security Considerations

- Files are stored with UUID names to prevent path traversal
- JWT tokens include user permissions for role-based access
- CORS is configured to allow all origins (restrict in production)
- File size limits should be configured in production

## Development

The service implementation follows the trait generated by the `file_service!` macro:

```rust
#[async_trait]
impl DocumentServiceServer for FileServiceImpl {
    async fn upload(...) -> Result<UploadResponse, FileServiceError> { }
    async fn upload_profile_picture(...) -> Result<UploadResponse, FileServiceError> { }
    async fn download(...) -> Result<Response<Body>, FileServiceError> { }
    async fn download_secure(...) -> Result<Response<Body>, FileServiceError> { }
}
```

The macro handles routing, authentication, and error handling automatically.